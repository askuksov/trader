# Техническое задание: Торговый бот с Smart DCA стратегией

## 1. Обзор проекта

### 1.1 Цель проекта
Разработка enterprise-grade торгового бота для спотовой торговли с реализацией Smart DCA (Dollar Cost Averaging) стратегии. Основной принцип: **"никогда не продавать в убыток"** - только LONG позиции с частичными продажами выше средней цены.

### 1.2 Ключевые характеристики
- **Технологический стек**: Go 1.25, MySQL 8, Redis, REST API
- **Биржи**: HitBTC (MVP), планируется Binance
- **Депозит**: $200-500 на торговую пару
- **Торговые инструменты**: Топ-100 монет по капитализации
- **Безопасность**: AES-256-GCM шифрование, JWT аутентификация, система ролей
- **Восстановление**: State recovery за <30 секунд

### 1.3 Архитектурные принципы
- Модульная архитектура с четким разделением ответственности
- Fault-tolerant дизайн с автоматическим восстановлением
- Enterprise-grade логирование и мониторинг
- Horizontal scaling готовность
- Zero data loss для позиций
- Многопользовательская система с ролями и правами

---

## 2. Smart DCA Стратегия (Основная логика)

### 2.1 Параметры стратегии (депозит $300)
```
Начальная покупка: $150 (50% депозита)

DCA уровни от цены входа:
├─ -3%: +$45 (15% депозита) 
├─ -7%: +$60 (20% депозита)
├─ -12%: +$45 (15% депозита)
└─ Резерв: $30 (10% депозита)

Take Profit от средней цены позиции:
├─ +8%: продать 25% позиции
├─ +15%: продать 35% позиции  
└─ +25%: продать 40% позиции
```

### 2.2 Критерии выбора пар
- Капитализация: топ-100 монет
- Ликвидность: минимум $10M дневной объем
- Волатильность: 3-15% дневная волатильность
- Исключения: стейблкоины, обваливающиеся проекты

---

## 3. Архитектура системы

### 3.1 Основные компоненты
- **Authentication & Authorization System** - JWT аутентификация, роли и права
- **User Management System** - управление пользователями и профилями
- **Position State Manager** - управление состоянием DCA позиций
- **DCA Engine** - основная торговая логика
- **Take Profit Manager** - управление частичными продажами
- **Key Manager** - управление API ключами с шифрованием
- **Exchange Connector** - интеграция с биржами
- **Risk Manager** - управление рисками
- **State Recovery** - восстановление после сбоев
- **Notification System** - уведомления через Telegram и Email

### 3.2 Технологии
- **Backend**: Go 1.25
- **Database**: MySQL 8 (основные данные), Redis (кэш и состояния)
- **API**: RESTful с OpenAPI спецификацией
- **Authentication**: JWT с RSA256
- **Мониторинг**: Prometheus + Grafana
- **Контейнеризация**: Docker

---

## 4. Система пользователей и безопасность

### 4.1 Архитектура безопасности
- **Multi-tenancy**: Полная изоляция данных пользователей
- **JWT аутентификация**: Access/Refresh токены с RSA256
- **Гранулярные права**: Ресурс + действие (api_keys:create, positions:read, etc.)
- **Роли**: Super Admin, Admin, Trader, Viewer
- **Прямые права**: С флагом разрешить/запретить, перекрывают права роли

### 4.2 Система прав доступа
```
Базовые права:
├─ API Keys: create, read, update, delete, read_own, manage_own
├─ Positions: create, read, update, delete, read_own, manage_own
├─ Analytics: read, read_own
├─ Users: create, read, update, delete
├─ Roles & Permissions: manage
└─ System: health_check
```

### 4.3 Функции пользователей
- **Регистрация и аутентификация**
- **Управление профилем** (редактирование, смена пароля)
- **Сброс пароля** через email
- **Персональные настройки** уведомлений
- **Изоляция данных** между пользователями

---

## 5. База данных

### 5.1 Основные таблицы системы безопасности
- **users** - Пользователи системы
- **roles** - Роли пользователей
- **permissions** - Права доступа
- **role_permissions** - Связь ролей и прав
- **user_permissions** - Прямые права пользователей (с флагом разрешить/запретить)
- **password_reset_tokens** - Токены для сброса пароля

### 5.2 Основные таблицы торговой логики
- **exchanges** - Биржи
- **coins** - Монеты/токены
- **trading_pairs** - Торговые пары
- **api_keys** - API ключи (привязанные к пользователям)
- **strategy_configs** - Конфигурации DCA стратегий
- **dca_positions** - DCA позиции (привязанные к пользователям)
- **dca_levels** - Уровни DCA для позиций
- **take_profit_levels** - Уровни Take Profit
- **position_transactions** - История всех операций

### 5.3 Вспомогательные таблицы
- **notification_settings** - Настройки уведомлений пользователей
- **strategy_dca_levels** - DCA уровни для стратегий
- **strategy_tp_levels** - Take Profit уровни для стратегий

---

## 6. API Endpoints

### 6.1 Аутентификация
```
POST /api/v1/auth/register           // Регистрация
POST /api/v1/auth/login              // Вход
POST /api/v1/auth/logout             // Выход
POST /api/v1/auth/refresh            // Обновление токена
POST /api/v1/auth/forgot-password    // Сброс пароля
POST /api/v1/auth/reset-password     // Подтверждение нового пароля
GET  /api/v1/auth/me                 // Профиль текущего пользователя
```

### 6.2 Управление пользователями
```
GET    /api/v1/users                 // Список пользователей (админы)
POST   /api/v1/users                 // Создать пользователя (админы)
GET    /api/v1/users/{id}            // Получить пользователя
PUT    /api/v1/users/{id}            // Обновить пользователя
DELETE /api/v1/users/{id}            // Деактивировать пользователя

PUT    /api/v1/profile               // Редактировать свой профиль
PUT    /api/v1/profile/password      // Смена пароля
```

### 6.3 Роли и права
```
GET    /api/v1/roles                 // Список ролей
POST   /api/v1/roles                 // Создать роль
PUT    /api/v1/roles/{id}            // Обновить роль
DELETE /api/v1/roles/{id}            // Удалить роль

GET    /api/v1/permissions           // Список всех прав
POST   /api/v1/permissions           // Создать право
```

### 6.4 API ключи
```
POST /api/v1/keys          // Создать ключ
GET  /api/v1/keys          // Список ключей (свои или все для админов)
GET  /api/v1/keys/{id}     // Получить ключ
PUT  /api/v1/keys/{id}     // Обновить ключ
DELETE /api/v1/keys/{id}   // Удалить ключ
GET  /api/v1/keys/{id}/test // Тест ключа
```

### 6.5 Позиции
```
POST /api/v1/positions              // Создать позицию
GET  /api/v1/positions              // Список позиций
GET  /api/v1/positions/{id}         // Детали позиции
PUT  /api/v1/positions/{id}/pause   // Приостановить
PUT  /api/v1/positions/{id}/resume  // Возобновить
DELETE /api/v1/positions/{id}       // Закрыть
```

### 6.6 Стратегии
```
POST /api/v1/strategies              // Создать стратегию
GET  /api/v1/strategies              // Список стратегий
GET  /api/v1/strategies/{id}         // Получить стратегию
PUT  /api/v1/strategies/{id}         // Обновить стратегию
DELETE /api/v1/strategies/{id}       // Удалить стратегию
```

### 6.7 Аналитика
```
GET /api/v1/analytics/positions/performance  // P&L по позициям
GET /api/v1/analytics/keys/performance       // Эффективность ключей
GET /api/v1/analytics/pairs/performance      // Статистика по парам
GET /api/v1/analytics/dca/efficiency         // Эффективность DCA
```

---

## 7. Критерии приемки проекта

### 7.1 Функциональные требования
- [x] **Аутентификация и авторизация**: Многопользовательская система с ролями и правами работает
- [x] **Система прав**: Прямые права с флагом разрешить/запретить функционируют корректно
- [x] **DCA позиции**: Создаются и управляются корректно с привязкой к пользователям
- [x] **Принцип безопасности**: "Никогда не продавать в убыток" соблюдается
- [x] **Восстановление состояния**: Работает за <30 секунд
- [x] **API ключи**: Поддержка нескольких ключей с балансировкой на пользователя
- [x] **Emergency stop**: Функциональность работает на разных уровнях
- [x] **Мониторинг**: Real-time мониторинг позиций с персонализацией
- [x] **Уведомления**: Система уведомлений через Telegram и Email с настройками пользователей

### 7.2 Технические требования
- [x] **Тестирование**: Все компоненты покрыты unit тестами (>80%)
- [x] **Интеграционные тесты**: Для критических сценариев включая авторизацию
- [x] **E2E тесты**: Для полного цикла DCA позиции с разными ролями
- [x] **API документация**: OpenAPI спецификация актуальна и включает авторизацию
- [x] **Контейнеризация**: Docker compose работает out-of-the-box
- [x] **Метрики**: Prometheus метрики экспортируются с разбивкой по пользователям

### 7.3 Производительность
- [x] **Обработка ордеров**: <1 секунды
- [x] **Мониторинг цен**: Real-time (<500ms задержка)
- [x] **Восстановление состояния**: <30 секунд
- [x] **Масштабируемость**: Поддержка 100+ активных позиций на 50+ пользователей
- [x] **Uptime**: >99.9%

### 7.4 Безопасность
- [x] **Шифрование**: API ключи зашифрованы AES-256-GCM
- [x] **Аутентификация**: JWT токены с RSA256 подписью
- [x] **Авторизация**: Гранулярная система прав работает корректно
- [x] **Аудит**: Нет утечек секретных данных в логах
- [x] **Валидация**: Всех входных данных с проверкой прав
- [x] **Rate limiting**: Защищает от DoS атак
- [x] **Логирование**: Аудит всех критических операций с указанием пользователя

---

## 8. Ответы на уточняющие вопросы

### 8.1 Техническая архитектура
1. **Deployment strategy**: ✅ **Docker Compose** достаточно для MVP
2. **Load balancing**: ✅ **Не требуется** horizontal scaling для MVP
3. **External dependencies**: ✅ **Планируется** интеграция с внешними сервисами, но **не в рамках MVP**
4. **Multi-tenancy**: ✅ **Реализована** через систему пользователей и ролей

### 8.2 Бизнес-логика
1. **Risk limits**: ✅ **Уточнение**: Лимиты по максимальному количеству активных позиций на API ключ и пользователя
2. **Fallback strategy**: ✅ **Уведомления** по всем каналам связи с персонализацией
3. **Commission handling**: ✅ **Модель комиссий** с поддержкой разных настроек на пользователя
4. **User isolation**: ✅ **Данные пользователей** изолированы друг от друга

### 8.3 Операционные аспекты
1. **Monitoring scope**: ✅ **Telegram и Email** с настройками на пользователя
2. **Backup strategy**: ✅ **Автоматический backup** - задача DevOps
3. **Maintenance windows**: ✅ **Планируются** с уведомлениями пользователей
4. **User management**: ✅ **Полноценная система** управления пользователями и ролями

### 8.4 Интеграции
1. **Frontend client**: ✅ **React клиент планируется** с аутентификацией
2. **Mobile access**: ✅ **API готово** для мобильных приложений
3. **Third-party tools**: ✅ **Возможна интеграция** в будущих версиях

---

## 9. Дополнительные требования

### 9.1 Расширенная модель данных
- **Пользователи** → **Роли** → **Права**
- **Прямые права** с флагом разрешить/запретить
- **API ключи** привязаны к пользователям
- **Позиции** изолированы по пользователям
- **Уведомления** персонализированы

### 9.2 Система аутентификации
- **JWT токены** с Access/Refresh механизмом
- **Сброс пароля** через email
- **Редактирование профиля** и смена пароля
- **Middleware** для проверки прав на каждом эндпоинте

### 9.3 Гранулярные права доступа
- **API Keys**: create, read, update, delete, read_own, manage_own
- **Positions**: create, read, update, delete, read_own, manage_own
- **Analytics**: read, read_own
- **Users**: create, read, update, delete
- **Roles & Permissions**: manage
- **System**: health_check

### 9.4 Базовые роли
- **Super Admin**: Все права системы
- **Admin**: Управление пользователями и их данными
- **Trader**: Управление своими ключами и позициями
- **Viewer**: Только просмотр своих данных

---

## 10. Оценка времени и ресурсов

### 10.1 Временные рамки
- **Общая оценка**: 13-14 недель для полного MVP
- **Критический путь**: Система безопасности → DCA Engine → Мониторинг
- **Параллельная разработка**: Некоторые компоненты могут разрабатываться параллельно

### 10.2 Команда
- **Минимум**: 1 Senior Go Developer (full-time) + 0.2 FTE на безопасность
- **Оптимально**: 1 Senior + 1 Middle Go Developer + Security консультант
- **DevOps support**: 0.5 FTE для настройки инфраструктуры
- **Frontend**: Отдельный React разработчик с опытом аутентификации

### 10.3 Риски и митигация
- **Сложность авторизации**: Митигация через тщательное тестирование прав доступа
- **Performance с проверкой прав**: Митигация через кэширование разрешений
- **Безопасность JWT**: Митигация через правильную ротацию ключей
- **Биржевое API**: Нестабильность HitBTC API - митигация через retry логику
- **State recovery**: Сложность восстановления - митигация через comprehensive testing

---

## 11. Технические зависимости

### 11.1 Go библиотеки
- `github.com/gofiber/fiber/v2` - HTTP framework
- `gorm.io/gorm` - ORM для работы с БД
- `github.com/redis/go-redis/v9` - Redis клиент
- `github.com/golang-jwt/jwt/v5` - JWT токены
- `golang.org/x/crypto/bcrypt` - хеширование паролей
- `gopkg.in/gomail.v2` - отправка email
- `github.com/google/uuid` - генерация UUID токенов
- `github.com/spf13/viper` - конфигурация
- `github.com/rs/zerolog` - логирование
- `github.com/prometheus/client_golang` - метрики

### 11.2 Конфигурации
```yaml
server:
  port: 8080
  host: "0.0.0.0"
  
database:
  host: "localhost"
  port: 3306
  name: "trading_bot"
  username: "root"
  password: "password"

redis:
  host: "localhost"
  port: 6379
  password: ""
  db: 0

jwt:
  access_secret: "your-access-secret-key"
  refresh_secret: "your-refresh-secret-key" 
  access_token_duration: "15m"
  refresh_token_duration: "168h"

email:
  smtp_host: "smtp.gmail.com"
  smtp_port: 587
  username: "your-email@gmail.com"
  password: "your-password"
  from_name: "Trading Bot"

telegram:
  bot_token: "your-bot-token"

security:
  bcrypt_cost: 12
  password_reset_expiry: "1h"
  max_login_attempts: 5
  lockout_duration: "30m"
```

---

## 12. Рекомендации

### 12.1 Архитектурные паттерны
- **Clean Architecture**: С четким разделением auth/business/data слоев
- **Repository Pattern**: Для изоляции данных пользователей
- **Middleware Pattern**: Для проверки аутентификации и авторизации
- **Strategy Pattern**: Для различных типов уведомлений

### 12.2 Безопасность
- **Принцип наименьших привилегий**: Пользователи получают минимально необходимые права
- **Defense in depth**: Многоуровневая защита (JWT + права + валидация)
- **Audit trail**: Полное логирование действий пользователей
- **Secure by default**: Безопасные настройки по умолчанию

### 12.3 Тестирование
- **Unit тесты**: Для всех компонентов (>80% покрытие)
- **Integration тесты**: Для проверки взаимодействия компонентов
- **Security тесты**: Для проверки изоляции данных пользователей
- **Performance тесты**: С нагрузкой от множественных пользователей
- **E2E тесты**: Для полных пользовательских сценариев

**Итоговая оценка MVP**: 350+ часов (13-14 недель) с полноценной системой безопасности enterprise-уровня.
