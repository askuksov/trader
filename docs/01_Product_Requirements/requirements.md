# Документ требований к продукту (PRD)

## 1. Цели и охват (MVP)

**Must have (обязательно):**  
- Бот для спотовой торговли с **Smart DCA стратегией** (вход → DCA усреднение → частичные продажи → завершение).  
- **Принцип "никогда не продавать в убыток"** - только LONG позиции с частичными продажами выше средней цены.
- Поддержка **нескольких API ключей** для биржи с привязкой к стратегиям и торговым парам.  
- REST API для управления ботом и интеграции с React-клиентом.  
- Приоритет на **надёжность, управление рисками и восстановление после сбоев**.  
- Поддержка биржи **HitBTC** (MVP).  
- **Депозит $200-500 на пару**, торговля монетами из топ-100 по капитализации.

**Should have (желательно):**  
- Детекция рыночных условий в реальном времени для автоматического переключения стратегий.
- Возможность мониторинга состояния ключей и их нагрузки.  
- Телеграм-уведомления о ключевых событиях (вход в позицию, DCA срабатывания, take profit, смена стратегии).  
- Автоматический выбор монет из топ-100 на основе волатильности и ликвидности.
- **Панель управления остановками** с детализацией по ключам и парам.

**Could have (можно добавить позже):**  
- Минимальная интеграция с ML-сервисом (прогноз направления цены и волатильности через HTTP API).  
- Поддержка нескольких бирж (Binance как первая после MVP).  
- Расширенные аналитические отчёты (P&L, эффективность ключей, портфельные метрики).  
- Динамическая корректировка DCA уровней на основе рыночных условий.

**Won't have (не входит в MVP):**  
- Сложные пайплайны машинного обучения и автоматический трейдинг на их основе.  
- Фьючерсная или маржинальная торговля.  
- SHORT позиции и продажа в убыток.
- Продвинутая визуализация (кроме базового дашборда).  

---

## 2. Торговая стратегия: Smart DCA

### 2.1 Основные принципы
- **Только LONG позиции** - никогда не продаем в убыток
- **Адаптивное усреднение** - увеличиваем объемы при больших просадках
- **Частичные продажи** - фиксируем прибыль постепенно
- **Резерв ликвидности** - всегда оставляем средства на экстремальные падения

### 2.2 Параметры стратегии (на депозит $300)
```
Начальная покупка: $150 (50% депозита)

DCA уровни от цены входа:
├─ -3%: +$45 (15% депозита) 
├─ -7%: +$60 (20% депозита)
├─ -12%: +$45 (15% депозита)
└─ Резерв: $30 (10% депозита) - на экстремальные падения

Take Profit от средней цены позиции:
├─ +8%: продать 25% позиции
├─ +15%: продать 35% позиции  
└─ +25%: продать 40% позиции
```

### 2.3 Критерии выбора торговых пар
- **Капитализация**: топ-100 монет по рыночной капитализации
- **Ликвидность**: минимальный дневной объем торгов $10M
- **Волатильность**: 3-15% дневная волатильность (оптимально для DCA)
- **Исключения**: стейблкоины, обваливающиеся проекты

---

## 3. Эталонная архитектура (бизнес-уровень)

**Must have:**  
- Backend на Go с модульной структурой.  
- MySQL для хранения данных (позиции, DCA уровни, история) и Redis для кэша.  
- REST API для клиента и управления ключами.  
- WebSocket для потоковых данных (мониторинг цен для DCA триггеров).  
- Базовая система аварийной остановки и восстановления состояния позиций.
- **Position State Manager** - модуль для отслеживания состояния DCA позиций.

**Should have:**  
- Docker для контейнеризации.  
- Kubernetes-готовность.  
- Healthchecks сервисов.  
- Prometheus + Grafana для базового мониторинга.  

**Could have:**  
- Расширенные алерты (мультиканальные уведомления).  
- Расширенные метрики (эффективность DCA стратегии, средние времена удержания позиций).  

**Won't have:**  
- Полный микросервисный разбор MVP.  
- Enterprise-grade observability на первом этапе.  

---

## 4. Основная доменная логика

**Must have:**  
- **Цикл кампании накопления**: создание → выбор стратегий → запуск → мониторинг рынка → переключение стратегий → достижение целей → завершение.
- **Управление стратегиями**: создание, редактирование, дублирование, активация/деактивация стратегий через UI.
- **Динамическое применение стратегий**: изменение параметров применяется к новым кампаниям, текущие кампании завершаются по старым настройкам.
- **Комбинирование стратегий** в рамках одной кампании (например, Grid + DCA одновременно).
- **Управление позициями LONG и SHORT** с соответствующими алгоритмами риск-менеджмента.
- Подсчёт размеров ордеров с учетом текущих средних цен позиций и целей накопления.  
- Управление состоянием кампаний и позиций при перезапуске системы.
- Управление рисками: лимиты по ключам, кампаниям, стратегиям, таймауты, защита от переторговки.  
- Назначение ключей для кампаний и стратегий.  

**Should have:**  
- **Версионирование стратегий** с историей изменений и возможностью отката.
- **Импорт/экспорт кампаний и стратегий** в JSON формате для бэкапа и миграции.
- Аналитика по эффективности кампаний и стратегий.  
- Отчёты о достижении целей накопления и ROI по кампаниям.  
- **Оптимизация балансировки** между стратегиями в рамках кампании.

**Could have:**  
- ML-сервис прогнозов для оптимизации точек входа и переключения стратегий.  
- Динамическая корректировка параметров стратегий на основе волатильности и рыночных условий.  
- **Рекомендации по оптимизации кампаний** на основе исторических данных.
- **Социальное копирование** успешных кампаний других пользователей.  

---

## 5. API (общее описание)

**Must have:**  
- Управление API ключами (CRUD).  
- Управление парами и настройками DCA стратегии.  
- Управление позициями (старт/стоп/пауза).  
- История позиций и транзакций.  
- Мониторинг активных позиций в реальном времени.

**Should have:**  
- Аналитика по ключам и парам.  
- Настройки уведомлений для DCA событий.
- Сервисные эндпоинты (статус, логи).  

**Could have:**  
- ML-эндпоинты для оптимизации стратегии.  
- Экспорт данных для анализа.

---

## 6. Критерии приёмки (Definition of Done)

- Архитектурный RFC согласован с учетом DCA стратегии.  
- База данных разворачивается с нуля с таблицами для позиций и DCA уровней.  
- Docker-compose работает.  
- Unit- и интеграционные тесты на DCA сценарии.  
- E2E-тесты на полный цикл DCA позиции с мульти-ключевыми сценариями.  
- Тестирование восстановления состояния позиций после перезапуска.
- OpenAPI спецификация доступна.  
- Документация по настройке DCA параметров.
